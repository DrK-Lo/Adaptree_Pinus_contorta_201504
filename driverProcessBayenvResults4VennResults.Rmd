---
title: "Outlier and Venn Diagram Results from Pinus contorta at different cutoffs"
author: "Katie Lotterhos"
date: "April 16, 2015"
output: html_document
---

In this analysis, we ran bayenv2 (Gunther and Coop 2013) on over 1,000,000 SNPs from the Pine sequence capture.  We had 22 environmental variables of biological interest.

```{r, echo=FALSE}
### set the wd
setwd("~/Desktop/bayenvResults20150416") #on Mac Pro
if(!("rmarkdown" %in% installed.packages())) {install.packages("rmarkdown", dependencies=TRUE)}
if(!("limma" %in% installed.packages())) {
  source("http://www.bioconductor.org/biocLite.R")
  biocLite("limma")
  }
library(rmarkdown)
library(limma)
library(xtable)
### rmarkdown::render("driverProcessBayenvResults4VennResults.Rmd")
````

### Information about this R session
```{r}
sessionInfo()
```

### The environmental variables used in this study

We performed a hierarchical cluster analysis on the 22 environmental variables as a way to summarize the outliers and account for correlated variables.
```{r}
env <- read.table("sprucePineEnvi.clusters", header=TRUE)
env
````

In the table above, column G3 represents the group from the hierarchical clustering.  For analysis, we took out Latitude, Longitude, and Elevation and analyzed them separately because they do not represent environments per se but rather variables that correlate with other selective pressures that we didn't measure (for example elevation may correlate with UV exposure).  So column G4 was used for analysis.

An image of the clustered environments for pine:
![cluster image](pineClusters.png)

The environments cluster into three groups.  Group 1 contains variables that correlate with mean annual temperature, Group 2 contains variables that correlate with mean annual precipitation, and Group 3 contains variables that correlate with frost-free period.


### The SNP dataset 

Here are the column names in the SNP dataset: (the ones named after the environments contain Bayes Factors.  "rho" represents Spearman's rho, which indicates the correlation between the reference SNP frequency and the environment.)

```{r}
filename <- "var_out_GATK3_allhet_pine688_ALL.summary.ALL.annots.sorted.GOOD.window.3xbf.log10"
### read in file with log-BF
  if(!("f2" %in% ls())){
    f2<- read.table(filename, header=TRUE, comment.char="")
  }
  names(f2)
```

The total number of SNPs used for analysis:
```{r}
nrow(f2)
```

The Bayes factors from all environments were pooled to calculate cutoffs for the 0.9999, 0.999, 0.99 and 0.95 quartiles of the BF distribution.  Here are the BF cutoffs for those percentiles:
```{r}
### read in file with cutoffs
  cos <- read.table(paste(filename,".cutoffs", sep=""), header=TRUE)
  cos
```

Now loop through each of these cutoffs (except for max) and summarize the results:

```{r xtable kable, echo=FALSE, results='asis'}
 colBF <- which(names(f2) %in% env$enviAbb)
  groupsize <- tapply(env$G4,env$G4, length)
  groupsize2 <- groupsize[2:4]/sum(groupsize[2:4])

  which.cutoffs <- 1:2
  envitable <- matrix()
### for each cutoff, 
  f3 <- f2

  for (i in which.cutoffs){
    BFcutoff <- round(cos[1,i],3)
    cutoff <- names(cos[i])
    cat("\n")
    cat("### Results for", cutoff, "percentile, which corresponds outliers with a BF >", BFcutoff, "\n")
     cat("\n")
    
      ### convert bF columns to T/F for outliers
      f3[,colBF] <- f2[,colBF] > BFcutoff
      #head(f3[,colBF])
    
      ### output number of outliers for each environment
      cat(paste ("**The number of outliers in each environmental variable with BF >", BFcutoff, "**", "\n"))
    eo <- data.frame(numOutliers = colSums(f3[,colBF], na.rm=TRUE))
      knitr::kable(eo, format="markdown", row.names=TRUE)
      print(xtable(eo), type="html")
    cat("\n")
    
      ### compute outliers for each cluster (3 columns) 
      G1cols <- which(names(f3) %in% env$enviAbb[env$G4==1])
      G2cols <- which(names(f3) %in% env$enviAbb[env$G4==2])
      G3cols <- which(names(f3) %in% env$enviAbb[env$G4==3])
    
      ### unit test
       if((length(G1cols) + length(G2cols) + length(G3cols))!=19){print("Error in envi clusters")}
    
      G1 <- rowSums(f3[,G1cols])>0
      G2 <- rowSums(f3[,G2cols])>0
      G3 <- rowSums(f3[,G3cols])>0
    
      overall.out <- rowSums(f3[,colBF])>0   
      # expected.num <- nrow(f3)*22*(1 - as.numeric(unlist(strsplit(names(cos)[i], "V"))[2]))
      cat("\n")
      cat("* **Number of latitude outliers:**", sum(f3$LAT, na.rm=TRUE), "\n")
    cat("\n")
      cat("* **Number of longitude outliers:**", sum(f3$LONG, na.rm=TRUE), "\n")
    cat("\n")
      cat("* **Number of elevation outliers:**", sum(f3$ELEVATION, na.rm=TRUE), "\n")
    
    cat("\n")
    cat("**Number of outliers in each group** (loci with an outlier an any one environment in group 1)", "\n")
    cat("\n")
      cat("* **Group 1** (temperature):", sum(G1, na.rm=TRUE), "\n")
    cat("\n")
      cat("* **Group 2** (precipitation):", sum(G2, na.rm=TRUE), "\n")
    cat("\n")
      cat("* **Group 3** (frost-free period):", sum(G3, na.rm=TRUE), "\n")
    cat("\n")
    
    cat("**Number of outliers in each group SCALED by the number of environmental variables in that group**", "\n")
    cat("\n")
      cat("* Scaled Group 1 (temperature):", round(sum(G1, na.rm=TRUE)/groupsize[2],1),"\n")
    cat("\n")
      cat("* Scaled Group 2 (precipitation):", round(sum(G2, na.rm=TRUE)/groupsize[3],1), "\n")
    cat("\n")
      cat("* Scaled Group 3 (frost-free period):", round(sum(G3, na.rm=TRUE)/groupsize[4],1), "\n")
    cat("\n")

    #cat(paste ("Continuuation of results for", cutoff, "percentile, which corresponds to a BF of", BFcutoff, "..."))
        cat("\n")
    cat(paste("#### Total number of outliers (loci with BF above threshold in any one environment):", sum(overall.out, na.rm=TRUE)), "\n")
    
      f3b <- data.frame(f3, G1, G2, G3, overall.out)
      
      #write.table(f3, paste(filename,"gt", names(cos[i]), sep=""))
      ### Venn diagram for Lat/Long/Elevation
      c1 <- names(f3b) %in% c("LAT", "LONG", "ELEVATION")
      TF.LLE <- f3b[,c1]
      counts.LLE <- vennCounts(TF.LLE)
      vennDiagram(counts.LLE, main = paste(cutoff, ", BF >", BFcutoff))
      
      ### Venn diagram for G1/G2/G3
      c2 <- names(f3b) %in% c("G1", "G2", "G3")
      TF.Gs <- f3b[,c2]
      counts.Gs <- vennCounts(TF.Gs)
      vennDiagram(counts.Gs, main = paste("Unscaled", cutoff, ", BF >", BFcutoff))
cat("\n")
      
  }# end loop
```